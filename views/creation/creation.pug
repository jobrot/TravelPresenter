extends ../layout

block content

  .row
      .col-sm-8
        .row
          .col-sm-8
            h4
                span(class="label label-default editableTitle" for="titleTextBox")
                  if album.title
                      span #{album.title}
                  else
                      span Click to Add Text
                input(value="" type="text" style="padding-down:10px;" id="titleTextBox" name="titleTextBox" class="blur" hidden)
          .col-sm-4
              //button(id="updateLocButton" class="btn btn-default" onclick="updateLocationsGoogleDrive()" disabled="true")
                span(class="glyphicon glyphicon-cloud-upload")
                  |Update image locations on Google Drive
              button(class="btn btn-link playablebutton pull-right" onclick="window.location.href='/play/" + album._id + "'")
                  span(class="glyphicon glyphicon-play-circle" style="font-size:2em;")
              button(class="btn btn-link pull-right" onclick="window.location.href='/creations'")
                  span(class="glyphicon glyphicon-floppy-disk" style="font-size:2em;")


        div(class="row" style="padding-up:10px;")
           div(id='map' style='height: 65vh;')
      div(class="col-sm-4" style="min-height: 75vh")
          div(class="pre-scrollable" style="min-height: 75vh")
            ol(id="sortable")
              - var n = 0
              - var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
              while n<album.images.length
                - var image = album.images[n]

                li(class="list-group-item text-center" id=image.filename)
                  .figure
                    .figcaption
                       b (#{labels[n % labels.length]})
                       | #{image.filename}
                    - n++
                    img(src="data:image/jpeg;base64, "+image.thumbnail.toString('base64') style="max-width:100%;max-height:100%;")

                  button(class="btn btn-default" style="margin:5px" onClick="setNewMarker('"+image.filename+"')")
                      span(class="glyphicon glyphicon-pushpin")
                  button(class="btn btn-default" style="margin:5px" onClick="removeFileFromAlbum('"+image.filename+"')")
                      span(class="glyphicon glyphicon-remove")


  script(type='text/javascript').
      $(function () {
          $("#sortable").sortable();
          $("#sortable").disableSelection();
      });
  script(type='text/javascript').
    var markers = [];
    var travelpath;
    var markerCluster;
    var map;
    function initMap() {
      console.log("initmap");

      //Find the first entry in the images containing coordinates
      var center = {lat: 48.2081743, lng: 16.3738189};
      for(i=0; i<album.images.length; i++){
          var image = album.images[i];
          if(image.lat && image.lng){
            center = image;
            break;
          }
      }

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 3,
        center: center
      });


      createPathfromLocations(album.images).setMap(map);
      addImagesToMap();


    }

    function addImagesToMap() {
        // Create an array of alphabetical characters used to label the markers.
        var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        console.log(album.images);

        if(markerCluster){
            markerCluster.clearMarkers();
        }

        markers = [];
        var playable = true;
        album.images.forEach(function (image, i) {
            //Remove thumbnails from the js object to save memory and post-space
            delete image.thumbnail;

            if (image.lat && image.lng) {
                markers.push(new google.maps.Marker({
                    _id: image.filename,
                    position: image,
                    label: labels[i % labels.length],
                    draggable: true
                }));
            }
            else{
                document.getElementById(image.filename).classList.add('list-group-item-warning');
                playable = false;
            }
        });
        album.playable = playable;
        if(playable){
            console.log("disabled = false");
            $(".playablebutton").prop('disabled', false);
        }
        else {
            console.log("disabled = true");
            $(".playablebutton").prop('disabled', true);
        }
        //Clear out previous marker Clusterers
        //if(markerCluster){
        //    markerCluster.setMap(null);
        //    console.log("markercluster map set to null");
        //}

        console.log("markercount: "+markers.length);
        console.log(markers);
        markerCluster = new MarkerClusterer(map, markers, {
            imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
            gridSize: '12'
        });

        markers.forEach((marker) => {
            marker.addListener('dragend', function() {
                album.images.forEach((image, index) => {
                    if(image.filename == marker._id){
                        image.lat = marker.position.lat();
                        image.lng = marker.position.lng();
                    }
                });
                resetPath();
                //document.getElementById("updateLocButton").disabled = false;
            });
            //marker.addListener('dragend', persistCreation(album));
        });

    }

    function createPathfromLocations(locs){
        var locswithoutempty = locs.filter(location => location.lat && location.lng);


        travelpath = new google.maps.Polyline({
            path: locswithoutempty,
            geodesic: true,
            strokeColor: '#FF0000',
            strokeOpacity: 1.0,
            strokeWeight: 2
        });
        return travelpath;
    }

    var album = !{JSON.stringify(album)};


    function setNewMarker(filename){
        console.log("setting for "+filename);
        //document.body.style.cursor = 'http://www.clker.com/cliparts/v/E/r/a/2/E/google-maps-marker-for-residencelamontagne.svg.hi.png';
        //document.documentElement.style.cursor = 'url("data:image/x-icon;base64,/9j/4AAQSkZJRgABAQAAYABgAAD/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/wAALCAAYABgBAREA/8QAGQAAAgMBAAAAAAAAAAAAAAAAAwcBAgUG/8QAIBAAAgICAgMBAQAAAAAAAAAAAQIDEQQFACEGEkFRYf/aAAgBAQAAPwBzcFkZEWJjS5M7ekUKF3aiaUCyaH85GJl4+diRZeJMk0Eyh45ENhgfo4bi082wt/5lnjA0ewyDohPHj7EIqBb9wGMbV7OFHbC6sV3RA7rRaHX+OatNdrIjFjp3RcsSaAJ7+mr6+3zQZQylTdEUaNcpDDFjQpDBGkUSD1VEWgo/AOE5/9k="), auto';
        //map.setOptions({draggableCursor:'url("data:image/x-icon;base64,R0lGODlh+gD6AOevAAAAAAEBAQICAgMDAwQEBAUFBQYGBgcHBwgICAoKCgsLCwwMDA0NDQ4ODg8PDxERERISEhQUFBYWFhcXFxgYGBkZGRoaGhsbGxwcHB0dHR4eHh8fHyAgICEhISIiIiQkJCUlJSYmJicnJygoKCkpKSoqKiwsLC4uLi8vLzAwMDExMTMzMzQ0NDU1NTY2Njk5OTw8PD09PUBAQEJCQkREREVFRUZGRkdHR0hISEpKSktLS0xMTE9PT1BQUFFRUVRUVFVVVVdXV1hYWFlZWVpaWltbW1xcXF1dXV5eXl9fX2BgYGNjY2RkZGZmZmhoaGlpaWpqamtra2xsbG1tbW5ubm9vb3V1dXZ2dnd3d3h4eHl5eXp6ent7e3x8fH19fX5+fn9/f4eHh4mJiYuLi4yMjI6OjpCQkJGRkZOTk5SUlJWVlZaWlpqampubm52dnZ6enqOjo6SkpKWlpaampqioqKmpqaqqqq2tra+vr7CwsLKysrW1tba2tri4uLq6ury8vL6+vr+/v8HBwcTExMXFxcbGxsfHx8jIyMnJycvLy8zMzNDQ0NHR0dPT09TU1NXV1dbW1tnZ2dvb29zc3N3d3d7e3uLi4uPj4+Tk5OXl5ebm5ujo6Onp6evr6+zs7O3t7e7u7u/v7/Dw8PHx8fLy8vPz8/X19ff39/j4+Pn5+fr6+vv7+/z8/P39/f7+/v///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////yH+EUNyZWF0ZWQgd2l0aCBHSU1QACH5BAEKAP8ALAAAAAD6APoAAAj+AP8JHEiwoMGDCBMqXMiwocOHECNKnEixosWLGDNq3Mixo8ePIEOKHEmypMmTKFOqXMmypcuXMGPKnEmzps2bOHPq3Mmzp8+fQIMKHUq0qNGjSJMqXcq0qdOnUKNKnUq1qtWrWLNq3cq1q9evYMOKHUu2rNmzaNOqXcu2rdu3cOPKnUu3rt27ePPq3cu3r9+/gAMLHky4sOHDiBMrXsy4sePHkCNLnky5suXLmDNr3sy5s+fPoEOLHk26tOnTqFOrXs26tevXsKs2SjMmT2yiPADoBkABz22gK3bvFtDmd88xwoUTN75TRXLlxZnjbPBcORvpNzFUt469JpLt3Lv+y3yEAPzw6+Jj0hlgXrcA9Olf1iHQHkAANfFhzq9/P798+u315x9LhihQn33wDXgSIxAcqJuACpYUyQQO7gZhhCFNYkGFwl2IYUeXdMBhch5+mBEnI4z4XIkmVtSJCSpWx2KLErEQ43Yz0uhQDDeCl6OOCuHQo3k/AmnQDkMGiJ+RDAWRJH9LMonQEk8eWKSOTlTpYABpSFnQFVpWyKWXAnURJodjSlnGmSOmCSQabKroZotuBBCnnG/QOAd7d6powCMm5lFAnzcy8WEfBxB6IwkYCpKAotV5QAaf23EQ4SEMQPrcCJj8Ewelz+Wg4CIPaJocCpwM9Ol2dgwIiQT+pgrngkFxACjcDwNOckGsu8WA0B8g7IYAFgNawgGvutmwECJy7KEgJyQgC4AOr92xwrXYZqvtttxeW4G0QcTmhbRsFvGbmeRW6QRzXKSbpBXYaeHujcR2l8W8aJIRHxb4WnmGf1T0a94AeQ4ohcDVFdBqhFEgLNwBvn0IhcMAJOAHjU8gvAAgQGaJ7wOHMNnEvBIs4uV35FbgCJn/HCHtBpOwLJARvIpwicwDFWFqCZrgTBARkK7Qic8FCUEoDEQfZHScMiSNUA9xBuL0QYDYeabUUxNESKZsYp31P1vf6fXUYYv9ddlmk811n2P7jDbbTr8NN9GDrN1eBjf02Db+mXKDl0HMUMe4t5R9b/f3QD4IjnPh1R1O0BAqDg4k4885XhDQHEpOI+XJWW4QzRVqbiLnwnl+kMsOio4h6buZjhDK9amuIOu6uZ5QEgfK7h/tANiukBKxG8m77wtlbJ7u6Q0fM0UTg4d8d8pf1PB2z0sXPUZTUN/i9RkF/Fz1v3GvURXffyj+RvIKBz5s53O0hfoRtt9Ru7qt35r8Ho0LgP2r4f/RF/vbnd3MQzyQgIF/qKmbgzJAia9FxH8OPMgjBui3BkbwISlY4PIu2JDsHaiAHCQIH6x2tw2GUCGboFB9QHhCgdTggyZsIULEAEMZLkQRBlhhDG1okA/U5wTsFuTh6wLUBCEqxA7tiYAejJiQSjjAPDPIBBMT8gLwEAAMU0zI+ypViCwiRBCgEg4QvJgQDVSnAXAg49Oq0wJJqPEga1gRFd4owUcJhwJ9oONBUJCcHnhCjwaZnm4QYAZAGmSEuykBIwxZkBTu5giMNAgNdKPESBYkDLqZQacsOZBEGOCKnCxICDhAiFASxAhjNOVA+JBGVQ5kaK6MpSxnScta2vKWuMylLnfJy1768pfADKYwh0nMYhrzmMhMpjKXycxmOvOZ0IymNKdJzWpa85rYzKY2t8nNbnrzm+AMpzjHSc5ymvOc6JRLQAAAOw=="), auto'});
        map.setOptions({draggableCursor:'crosshair'})

        var listener=  map.addListener('click', function(e) {
            var playable = true;
            album.images.forEach((image) => {
                if(image.filename == filename){
                    image.lat = e.latLng.lat();
                    image.lng = e.latLng.lng();
                    document.getElementById(image.filename).classList.remove('list-group-item-warning');
                }
                if(!(image.lat && image.lng)){
                    playable = false;
                }
            });
            album.playable = playable;
            if (playable) {
                console.log("disabled = false");
                $(".playablebutton").prop('disabled', true);
            }
            else {
                console.log("disabled = true");
                $(".playablebutton").prop('disabled', true);
            }
            resetPath();
            addImagesToMap();
            google.maps.event.removeListener(listener);
            map.setOptions({draggableCursor:'default'});
            persistCreation(album);

            //document.getElementById("updateLocButton").disabled = false;
        });
    }

    function removeFileFromAlbum(filename) {
        album.images.forEach((image, index, object)=> {
               if(image.filename ==filename){
                    object.splice(index, 1);
               }
            });

        var playable = true;
        album.images.forEach(image => {
            if(!(image.lat && image.lng)){
                playable=false;
            }
        });
        album.playable=playable;
        if (playable) {  //TODO extract to function
            console.log("disabled = false");
            $(".playablebutton").prop('disabled', true);
        }
        else {
            console.log("disabled = true");
            $(".playablebutton").prop('disabled', true);
        }


        var element = document.getElementById(filename);
        element.parentNode.removeChild(element);
        resetPath();
    }

    function resetPath() {
        console.log("reset");
        var map = travelpath.getMap();
        travelpath.setMap(null);
        createPathfromLocations(album.images);
        travelpath.setMap(map);
        updatePositionsPersistCreation(album);
    }


    var idsInOrder = [];
    function sortArrayWithComparatorArray(a, b) {
        return idsInOrder.indexOf(a._id) - idsInOrder.indexOf(b._id);
    }
    var sortAndUpdateMap = function () {
        //var idsInOrder = $("#sortable").sortable("refreshPositions").children();

        idsInOrder = $("#sortable").sortable("toArray");

        //This part just changes the markers around, but they actually dont even have to be moved
        //console.log("markers before:");
        //console.log(markers);
        //markers.sort(sortArrayWithComparatorArray);
        //console.log("markers after:");
        //console.log(markers);

        //console.log("locations: ");
        //console.log(album.images);
        album.images.sort(sortArrayWithComparatorArray);
        //console.log(album.images);
        var map = travelpath.getMap();
        travelpath.setMap(null);
        createPathfromLocations(album.images);
        travelpath.setMap(map);
        updatePositionsPersistCreation(album);
        //TODO persistcreation muss alles durchgehen und ordnen, sowie das ganze album haben (jetzt ist hier nur locations)
    }



    $("#sortable").sortable({
        stop: sortAndUpdateMap
    });

    function updatePositionsPersistCreation(album) {

        album.images.forEach((image, index) =>{
           image.position = index;
        });
        persistCreation(album);

    }

    function persistCreation(album){
        $.ajax({
            type: "POST",
            url: "/creation",
            data: {
                album: album,
                _csrf: "#{_csrf}"
            }
        });
    }

    function updateLocationsGoogleDrive() {

        $.ajax({
            type: "POST",
            url: "/creation/updatelocations",
            data: {
                album: album,
                _csrf: "#{_csrf}"
            }
        });
        //document.getElementById("updateLocButton").disabled = true;
    }


    //Code for editable label
    $('.editableTitle').click(function () {
        "use strict";
        $(this).hide();
        $('#' + $(this).attr('for'))
            .val($(this).text())
            .toggleClass("form-control")
            .show()
            .focus();
    });


    document.getElementById('titleTextBox').addEventListener('keyup', function (e) {
        if (e.which == 13) this.blur();
    });
    $( document ).ready(function() {
        $('.pre-scrollable').slimScroll({height: '75vh'});
    });

    $('.blur').blur(function () {
        "use strict";
        $(this)
            .hide()
            .toggleClass("form-control");
        var myid = (this).id;
        $('span[for=' + myid + ']')
            .text($(this).val())
            .show();
        album.title = $(this).val();
        persistCreation(album);
    });


  script(type='text/javascript' src='https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js' )
  //TODO Client API Key has to be Restricted after development is finished
  script(type='text/javascript' src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu_4PKulFGlZtAB10E-ekucVFzm2KzSxk&callback=initMap")
  script(type='text/javascript' src="http://rawgithub.com/rochal/jQuery-slimScroll/master/jquery.slimscroll.js")